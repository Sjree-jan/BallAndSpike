<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App â€“ TON Wallet Connect</title>
  <!-- Include TON Connect SDK (via CDN) -->
  <!-- <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js" defer></script> -->
  <script type="module">
    import { TonConnect } from "https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.mjs";
    window.TonConnect = TonConnect;
</script>


</head>
<body>
  <h2>TON Wallet Connection Demo</h2>
  
  <!-- Unity WebGL game container (for compatibility; your game canvas can be placed here) -->
  <div id="gameContainer">
    <!-- Example Unity Canvas (replace with your actual Unity WebGL canvas if needed) -->
    <!-- <canvas id="unity-canvas"></canvas> -->
  </div>
  
  <!-- Connect to TON Wallet button -->
  <button id="connect-btn">Connect to TON Wallet</button>
  
  <!-- Display area for the connected wallet address -->
  <p id="wallet-address"></p>
  
  <script>
    // Wait for the DOM content to load and SDK to be ready
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize TON Connect SDK (with manifest URL for your app)
      const connector = new TonConnectSDK.TonConnect({
        // **Replace the manifestUrl with your app's actual URL hosting tonconnect-manifest.json**
        manifestUrl: window.location.origin + '/tonconnect-manifest.json'
      });
      
      // Restore session if the user has connected before (ensures persistent connection across page reloads)
      await connector.restoreConnection();
      
      // Subscribe to connection status changes to handle connect/disconnect events
      connector.onStatusChange((walletInfo) => {
        const addressEl = document.getElementById('wallet-address');
        const connectBtn = document.getElementById('connect-btn');
        if (connector.connected && walletInfo.account) {
          // Wallet connected successfully: display the wallet address
          const userAddress = walletInfo.account.address;
          addressEl.textContent = 'Wallet Address: ' + userAddress;
          // Update the button text to indicate connection (optional)
          connectBtn.textContent = 'Connected';
          connectBtn.disabled = true;
        } else {
          // Wallet not connected or disconnected
          addressEl.textContent = '';
          connectBtn.textContent = 'Connect to TON Wallet';
          connectBtn.disabled = false;
        }
      });
      
      // Handle the Connect button click
      document.getElementById('connect-btn').addEventListener('click', async () => {
        try {
          // Fetch the list of available TON wallets (supported by TON Connect)
          const wallets = await connector.getWallets();
          
          // Check if there's an injected or embedded wallet (e.g., TON Wallet in Telegram or browser extension)
          const injectedWallet = wallets.find(wallet => wallet.embedded || wallet.injected);
          if (injectedWallet) {
            // Connect directly to the injected/embedded wallet
            connector.connect({ jsBridgeKey: injectedWallet.jsBridgeKey });
            return;
          }
          
          // No injected wallet found: proceed with a remote wallet (Tonkeeper as default)
          const tonkeeperWallet = wallets.find(wallet => 
            wallet.name.toLowerCase().includes('tonkeeper')
          ) || wallets.find(wallet => !wallet.injected && !wallet.embedded);
          
          if (tonkeeperWallet) {
            // Initiate connection via the wallet's universal link and bridge (for Tonkeeper or other remote wallets)
            const connectionLink = connector.connect({
              universalLink: tonkeeperWallet.universalLink,
              bridgeUrl: tonkeeperWallet.bridgeUrl
            });
            // Open the wallet link for the user.
            // In Telegram Mini App on mobile, this should open the TON wallet app (e.g., Tonkeeper).
            window.open(connectionLink, '_blank');
          } else {
            console.error('No TON wallets available for connection.');
          }
        } catch (error) {
          console.error('Failed to connect to TON wallet:', error);
        }
      });
    });
  </script>
</body>
</html>
